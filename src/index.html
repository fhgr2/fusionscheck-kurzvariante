<!DOCTYPE html>
 
<html>
 
<head>
<title>Fusionscheck</title>
<meta charset="UTF-8" />

<!-- <link href="style.css" type="text/css" rel="stylesheet" /> -->
<style>

</style>
 
</head>
 
<body>
 
<div id="content_center" style="width: 490px; border: 1px solid black; margin-top: 200px">
	<script src="http://www.htwchur.ch/fileadmin/user_upload/institute/IKT/Forschung_und_Dienstleistung/Fusionscheck/jquery-1.7.2_min.js"></script>
	<script src="https://ajax.googleapis.com/ajax/libs/jqueryui/1.8.24/jquery-ui.min.js"></script>
	<link rel="stylesheet" type="text/css" href="http://www.htwchur.ch/typo3temp/stylesheet_e1077a5f41.css?1343398863">
	<link rel="stylesheet" type="text/css" href="http://fonts.googleapis.com/css?family=Arvo:700,700italic,400">
	<link rel="stylesheet" type="text/css" href="http://www.htwchur.ch/fileadmin/css/smoothness/jquery-ui-1.8.16.custom.css">
	<link rel="stylesheet" type="text/css" href="http://www.htwchur.ch/fileadmin/css/style.css?2013061423424">
	<!-- jQuery 1.7.2 is loaded automatically in Typo3 -->
	<!-- <script src="http://code.jquery.com/jquery-1.7.2.min.js"></script> --> 
	
	<!-- cut here ✂ ------------------------- -->
	
	<script src="http://www.htwchur.ch/fileadmin/user_upload/institute/IKT/Forschung_und_Dienstleistung/Fusionscheck/d3.min.js"></script>
	<script src="http://www.htwchur.ch/fileadmin/user_upload/institute/IKT/Forschung_und_Dienstleistung/Fusionscheck/radar-chart.min.js"></script>
	<script src="http://www.htwchur.ch/fileadmin/user_upload/institute/IKT/Forschung_und_Dienstleistung/Fusionscheck/URI.js"></script>

	
	<div id="scoped-content"> 
		<style type="text/css" scoped> /* may not be scoped in certain browsers, but that should not matter since we (mostly) won't override css from typo3 */
		
		.questiontext {
			width: 450px;
		}

		#questiontable td {
			padding-bottom: 10px;
		}
		
		#questiontable .ui-state-default, #questiontable .ui-state-active, #questiontable .ui-widget-content {
			border-color: #fff;
			border-right-color: #fff;
			background: none;
		}
		
		#questiontable {
			font-size: 12px; /* overwrites jquery ui css */
			font-family: Arial,Helvetica,sans-serif; /* overwrites jquery ui css */
		}
		
		#body {
			margin-top: 20px;
		}
		
		#questiontable h3 {
			font-size: 19px; /* overwrites jquery ui css */
			padding-left: 30px;
		}
		
		#questiontable ui-accordion-content {
			padding-right: 0px;
		}
		
		.fcinput {
			width: 40px;
			text-align: right;
		}
		
		svg.radar-chart {
			height: 500px;
		}
		
		/* radar chart options */
		.radar-chart .level {
			stroke: grey;
			stroke-width: 0.5;
		}

		.radar-chart .axis line {
			stroke: grey;
			stroke-width: 1;
		}

		.radar-chart .axis .legend {
			font-family: sans-serif;
			font-size: 10px;
		}

		.radar-chart .axis .legend.top {
			dy:1em;
		}

		.radar-chart .axis .legend.left {
			text-anchor: start;
		}

		.radar-chart .axis .legend.middle {
			text-anchor: middle;
		}

		.radar-chart .axis .legend.right {
			text-anchor: end;
		}

		.radar-chart .tooltip {
			font-family: sans-serif;
			font-size: 13px;
			transition: opacity 200ms;
			opacity: 0;
		}

		.radar-chart .tooltip.visible {
			opacity: 1;
		}

		/* area transition when hovering */
		.radar-chart .area {
			stroke-width: 2;
			fill-opacity: 0.5;
		}

		.radar-chart.focus .area {
			fill-opacity: 0.1;
		}

		.radar-chart.focus .area.focused {
			fill-opacity: 0.7;
		}

		.radar-chart .circle {
			fill-opacity: 0.9;
		}

		/* radar chart transitions */
		.radar-chart .area, .radar-chart .circle {
			transition: opacity 300ms, fill-opacity 200ms;
			opacity: 1;
		}
		
		.radar-chart .d3-enter, .radar-chart .d3-exit {
			opacity: 1;
		}
		
		</style>
		
		<div id="questiontable">
			<h3 id="category1" class="questioncategory">Finanzielle Leistungsfähigkeit</h3>
			<div>
			<div class="questiontext">Wie hoch ist der Selbstfinanzierungsanteil in Ihrer Gemeinde gemäss Statistik der laufenden Gemeinderechnung?</div><br>
			<input class="fcinput" id="input1" type="text" size="3"/> %
			</div>
			
			<h3 id="category2" class="questioncategory">Professionalität</h3>
			<div>
			<div class="questiontext">Wie viele Stunden pro Woche ist der Schalter des Gemeindehauses geöffnet? (Zählen Sie die Stunden vor 08:00 Uhr, zwischen 12:00 und 14:00 und diejenigen nach 17:00 Uhr doppelt.)</div><br>
			<input class="fcinput" id="input2" type="text" size="3"/> h
			</div>
			
			<h3 id="category3" class="questioncategory">Aussenwirkung</h3>
			<div>
			<div class="questiontext">Wie gross ist der Einfluss Ihrer Gemeinde auf die kantonale Politik? (0 = kein Einfluss bis 4 = grosser Einfluss)</div><br>
			<input class="fcinput" id="input3" type="text" size="3"/>  Pkte
			</div>
			
			<h3 id="category4" class="questioncategory">Standortattraktivität</h3>
			<div>
			<div class="questiontext">Wie hoch sind die jährlichen Steuererträge der natürlichen Personen pro Einwohner?</div><br>
			<input class="fcinput" id="input4" type="text" size="3"/> CHF
			</div>
			
			<h3 id="category5" class="questioncategory">Mitwirkungsrechte</h3>
			<div>
			<div class="questiontext">Wie hoch ist der Anteil an Stimmberechtigten, die für die Einreichung einer Initiative benötigt sind (Quorum)?</div><br>
			<input class="fcinput" id="input5" type="text" size="3"/> %
			</div>
			
			<h3 id="category6" class="questioncategory">Partizipation</h3>
			<div>
			<div class="questiontext">Wie hoch ist die durchschnittliche Stimmbeteiligung für kommunale Angelegenheiten?</div><br>
			<input class="fcinput" id="input6" type="text" size="3"/> %
			</div>
			
			<h3 id="category7" class="questioncategory">Filz / "Vetterliwirtschaft"</h3>
			<div>
			<div class="questiontext">Wie viele Offerten haben Sie im Durchschnitt pro Submissionsverfahren eingeholt?</div><br>
			<input class="fcinput" id="input7" type="text" size="3"/> Off.
			</div>
			
			<h3 id="category8" class="questioncategory">Bürgernähe</h3>
			<div>
			<div class="questiontext">Wie hoch ist der Anteil der angenommenen Vorlagen des Gemeindevorstandes (an Gemeindeversammlung und/oder Urnengemeinde)?</div><br>
			<input class="fcinput" id="input8" type="text" size="3"/> %
			</div>
			
			<h3 id="category9" class="questioncategory">Soziale Integration</h3>
			<div>
			<div class="questiontext">Wie viele  Gesuche zur Durchführung einer Veranstaltung von Vereinen wurden im letzten ganzen Jahr eingereicht?</div><br>
			<input class="fcinput" id="input9" type="text" size="3"/> Ges.
			</div>
			
			<h3 id="category10" class="questioncategory">Identifikation mit Gemeinde</h3>
			<div>
			<div class="questiontext">Wie hoch ist der Anteil an Wochenaufenthaltern in Ihrer Gemeinde? (Anzahl Wochenaufenthalter / ständige Wohnbevölkerung (STATPOP))</div><br>
			<input class="fcinput" id="input10" type="text" size="3"/> %
			</div>
		</div>
	
		<div id="body">
			<div id="chart"></div>
		</div>
	
	</div>
	
	<script>
	// mostly taken from http://bl.ocks.org/nbremer/6506614
	var w = 490;
	var h = 490;

	var colorscale = d3.scale.category10();

	//Legend titles
	var LegendOptions = ['ZVM-Benchmark-Index','Ihre Gemeinde'];

	//Data
	var d = [
				[
					{value:50},
					{value:57},
					{value:63},
					{value:57},
					{value:36},
					{value:42},
					{value:25},
					{value:70},
					{value:50},
					{value:83},
				],[
					{value:0},
					{value:0},
					{value:0},
					{value:0},
					{value:100},
					{value:0},
					{value:0},
					{value:0},
					{value:0},
					{value:100},
				]
			];
	var d_plot;
			
	var limits = [
		{lower:0,   upper:30},
		{lower:14,  upper:42},
		{lower:0,   upper:4},
		{lower:500, upper:4000},
		{lower:1,   upper:15},
		{lower:5,   upper:65},
		{lower:2,   upper:6},
		{lower:0,   upper:100},
		{lower:0,   upper:30},
		{lower:0,   upper:30},
	];
	
	// register callback functions for changing forms
	$('.fcinput').keyup(function(){
		update();
	});
	
	$(document).ready(function(){
		update();
		$('#input1').select();
		$('#input1').focus();
		
		assignKeysToNext();
	});
	
	// Define behaviour of Enter/Tab in Forms
	function assignKeysToNext() {
		$('.fcinput').keydown(function(event){ // https://stackoverflow.com/questions/16889576/keypress-on-tab-not-working
			var pattern = /\d+/; //Regex: one or more digits
			var currentQuestion = parseInt(pattern.exec($(this).attr("id"))[0]); // executing the regex returns an array
			var nextQuestion = currentQuestion+1;
			if (currentQuestion < 10) { // skip last question
				var keycode = (event.keyCode ? event.keyCode : event.which); // http://stackoverflow.com/a/9690459
				if(keycode == '13' || keycode == '9') { // 13: Enter, 9: Tab
					$("#questiontable").accordion("option", "active", nextQuestion-1); // accordion index starts with 0
				}
			}
		});
	}
	
	function update() {
		// Read input data and put them into json
		for (var q=1; q<=10; q++) {
			var input = parseFloat($('#input'+q).val());
			if (isNaN(input)) {
				if (q!=5 && q!=10) {
					input = 0;
				} else {
					input = 100;
				}
			}
			var lower = limits[q-1].lower;
			var upper = limits[q-1].upper;
			input = Math.max(input,lower);
			input = Math.min(input,upper);
			if (q!=5 && q!=10) {
				d[1][q-1].value = Math.round(100*((input-lower)/(upper-lower)));
			} else {
				d[1][q-1].value = Math.round(100*(1-(input-lower)/(upper-lower)));
			}
		}
		
		// update data to be plotted
		d_plot = deepCopy(d);
		
		// Change order of data (to print it in CW order)
		// d_plot[0][0] = d[0][0]; // implicitly
		for (var i=1; i<=9; i++) {
			d_plot[0][i] = d[0][10-i];
			d_plot[1][i] = d[1][10-i];
		}
		
		RadarChart.draw("#chart", d_plot, mycfg);
	}
	
	function deepCopy(oldObject) {
		//return jQuery.extend(true, {}, oldObject); // deep-copy according to http://stackoverflow.com/questions/122102/what-is-the-most-efficient-way-to-clone-an-object ; seems not to work
		return oldObject.map(function(a){return a.slice();}); // deep-copy according to http://stackoverflow.com/a/13756775
	}
	
	function getColor(i) {
		if (i==0){
			return 'hsl(204,100%,34%)';
		} else {
			return 'hsl(0,60%,50%)';
		}
	}
	
	$(function() {
		$("#questiontable").accordion({
			collapsible: true,
			change: function(event, ui) { // 'changestart' can't focus
				ui.newContent.find("input").select();
				ui.newContent.find("input").focus();
			}
		});
	});
	
	// Read axis titles from html and put them into json
	for (var i=1; i<=10; i++) {
		d[0][i-1].axis = document.getElementById("category"+i).innerHTML;
		d[1][i-1].axis = document.getElementById("category"+i).innerHTML;
	}

	//Options for the Radar chart, other than default
	var mycfg = {
		w: w,
		h: h,
		maxValue: 100,
		levels: 5,
		ExtraWidthX: 300,
		color: getColor
	}

	update();
	
	////////////////////////////////////////////
	/////////// Initiate legend ////////////////
	////////////////////////////////////////////

	var svg = d3.select('#body')
		//.selectAll('svg')
		.append('svg')
		.attr("width", w+300)
		.attr("height", 70)
		;
	//Create the title for the legend
	var text = svg.append("text")
		.attr("class", "title")
		.attr('transform', 'translate(-400,0)') 
		.attr("x", w - 70)
		.attr("y", 10)
		.attr("font-size", "12px")
		.attr("fill", "#404040")
		.text("Legende");
			
	//Initiate Legend	
	var legend = svg.append("g")
		.attr("class", "legend")
		.attr("height", 100)
		.attr("width", 200)
		.attr('transform', 'translate(-400,20)') 
		;
		
	//Create colour squares
	legend.selectAll('rect')
		.data(LegendOptions)
		.enter()
		.append("rect")
		.attr("x", w - 65)
		.attr("y", function(d, i){ return i * 20;})
		.attr("width", 10)
		.attr("height", 10)
		.style("fill", function(d, i){ return getColor(i);})
		;
		
	//Create text next to squares
	legend.selectAll('text')
		.data(LegendOptions)
		.enter()
		.append("text")
		.attr("x", w - 52)
		.attr("y", function(d, i){ return i * 20 + 9;})
		.attr("font-size", "11px")
		.attr("fill", "#737373")
		.text(function(d) { return d; })
		;
	</script>
	<script>
		var DATA_PREFIX = 'input';

		/**
		 * Return non-empty question values from the DOM.
		 *   
		 * @return {object.<string,string>} the non-empty question values, e.g. { input1: 50 }
		 }
		 */
		function readQuestionValues() {
			var index;
			var key;
			var value;
			var values = {};
			for (index = 1; index <= 10; index++) {
				key = DATA_PREFIX + index;
				value = $('#' + key).val();
				if (value !== undefined && value !== '') {
					values[key] = value;
				}
			}
			return values;
		}

		/**
		 * Write the question values to the DOM.
		 *
		 * @param {object.<string,string>} the question values, e.g. { input1: 50 }
		 */
		function writeQuestionValues(values) {
			var index;
			var key;
			var value;
			for (index = 1; index <= 10; index++) {
				value = values[DATA_PREFIX + index];
				if (value !== undefined) {
					$('#' + DATA_PREFIX + index).val(value);
				} else {
					$('#' + DATA_PREFIX + index).val('');
				}
			}
		}

		/**
		 * Encode the values into the URL as query like data to the fragment.
		 *
		 * Example:
		 *   generateURL('example.com', {input1=50})  --> 'example.com#?input1=50'
		 *
		 * @param {string} the url to add the question values to.
		 * @param {object.<string,string>} the question values, e.g. {input1: 50}
		 */
		function generateURL(url, values) {
			var uri = new URI(url);
			uri.fragment(values);
			return uri.toString();
		}

		/**
		 * Parse the url's fragment as query like data.
		 *
		 * Example:
		 *   parseURL("example.com#?category1=50")  --> {input1: 50}
		 *
		 * @param {string} the url
		 * @return {object.<string,string> the question values, e.g. {input1: 50}
		 */
		function parseURL(url) {
			var uri = new URI(document.URL);
			return uri.fragment(true);
		}

		/**
		 * Get URL with the question values encoded into the URL as query like data to the fragment.
		 *
		 * @return {string} the URL with the question values encoded
		 */
		function generateURLWithQuestionValues() {
			var url = generateURL(document.URL, readQuestionValues());
			$('#urlInput').val(url);
		}

		/**
		 * Generate and URL with the question values encoded as query in the fragment part of the URL.
		 */
		function parseURLAndWriteQuestionValues() {
			var values = parseURL(document.URL);
			writeQuestionValues(values);
		}

		parseURLAndWriteQuestionValues();
	</script>

	<div id="url">
    <button onClick="generateURLWithQuestionValues();" id="urlButton">Generiere Link</button>
    <input id="urlInput" type="text" size="50"></input>
  </div>
 <!-- cut here ✂ ------------------------- -->
</div>
</body>
</html>